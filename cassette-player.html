<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>cassette tape player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Lucida Console', monospace;
      background: #fff;
      margin: 0;
      padding: 0;
      color: #222;
    }
    h1 {
      text-align: center;
      font-size: 2.2rem;
      letter-spacing: .14em;
      margin-top: 2rem;
    }
    .tab-group {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 1.5rem;
    }
    .tab-btn {
      font-family: 'Lucida Console', monospace;
      padding: 10px 32px;
      border: none;
      border-radius: 12px 12px 0 0;
      background: #eee;
      font-size: 1.1rem;
      cursor: pointer;
      color: #222;
      outline: none;
      transition: background .2s;
    }
    .tab-btn.active {
      background: #222;
      color: #ffe800;
    }

    .input-row {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 8px;
      margin: 1.4rem 0 0.2rem;
      flex-wrap: wrap;
    }
    .input-row input {
      font-family: 'Lucida Console', monospace;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #bbb;
      font-size: 1.1rem;
      outline: none;
      width: 260px;
      max-width: 90vw;
      margin-bottom: 0;
    }
    .add-btn, .share-btn {
      font-family: 'Lucida Console', monospace;
      padding: 10px 0;
      border: none;
      background: #222;
      color: #fff;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1rem;
      width: 260px;
      max-width: 90vw;
      margin-top: 7px;
      transition: background .2s;
      display: block;
    }
    .add-btn:hover, .share-btn:hover {
      background: #444;
    }

    .cassette-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 36px 0 20px;
      position: relative;
    }
    .cassette-img {
      width: 99vw;
      max-width: 480px;
      border-radius: 18px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.16);
      position: relative;
      z-index: 0;
      background: #eee;
      margin: 0 auto;
      display: block;
    }
    .track-list {
      position: absolute;
      top: 11.5%;
      left: 50%;
      transform: translateX(-50%);
      width: 81%;
      color: #fff;
      text-align: center;
      font-weight: bold;
      font-size: 1.1rem;
      text-shadow: 2px 2px 8px #111, 0 1px 0 #222;
      z-index: 2;
      line-height: 1.6;
      letter-spacing: 1.5px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      pointer-events: none;
      min-height: 4.2em;
    }
    .track-list .playing {
      color: #ffe800;
      text-shadow: 2px 2px 8px #444, 0 1px 0 #000;
    }
    .track-list .del-btn {
      pointer-events: auto;
      background: rgba(0,0,0,0.28);
      border: none;
      color: #fff;
      font-size: 1rem;
      margin-left: 0.5em;
      border-radius: 4px;
      cursor: pointer;
      padding: 2px 8px;
      vertical-align: middle;
      transition: background 0.15s;
    }
    .track-list .del-btn:hover {
      background: #f35;
      color: #fff;
    }
    .player-controls {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .ctrl-btn {
      font-size: 2.3rem;
      background: #f5f5f5;
      border: 2px solid #ddd;
      border-radius: 11px;
      padding: 7px 19px;
      cursor: pointer;
      color: #3890e8;
      margin-bottom: 8px;
      transition: background 0.18s, color 0.18s;
    }
    .ctrl-btn:hover, .ctrl-btn.active {
      background: #222;
      color: #ffe800;
    }
    @media (max-width: 520px) {
      h1 { font-size: 1.17rem; }
      .cassette-img { max-width: 98vw; }
      .track-list { width: 96%; font-size: 0.92rem; }
      .ctrl-btn { font-size: 1.45rem; padding: 5px 9px; }
      .player-controls { gap: 6px; }
      .add-btn, .share-btn, .input-row input { font-size: 1.01rem; width: 97vw; max-width: 97vw;}
    }
    @media (max-width: 520px) {
      .input-row {
        flex-direction: column;
        align-items: stretch;
        gap: 0;
      }
      .input-row input { margin-bottom: 7px; }
      .add-btn, .share-btn { margin-top: 0; margin-bottom: 7px;}
    }
    @media (max-width: 520px) {
      .player-controls.touch {
        flex-wrap: wrap;
        gap: 6px;
      }
      .ctrl-btn.tiny {
        font-size: 1.1rem;
        padding: 5px 7px;
        min-width: 55px;
        width: 27vw;
        max-width: 100px;
      }
    }
  </style>
</head>
<body>
  <h1>cassette tape player</h1>

  <div class="tab-group">
    <button class="tab-btn active" id="tabA">A面</button>
    <button class="tab-btn" id="tabB">B面</button>
  </div>

  <div class="input-row">
    <input type="text" id="trackTitle" placeholder="曲タイトル">
    <input type="text" id="trackUrl" placeholder="YouTubeリンク">
    <button class="add-btn" id="addBtn">この面に追加</button>
    <button class="share-btn" id="shareBtn">シェア</button>
    <span id="shareMsg" style="margin-left: 8px; color:#12b560; font-weight:bold; display:none;">コピーしました！</span>
  </div>

  <div class="cassette-container" style="position:relative;">
    <img class="cassette-img" id="cassetteImg" src="cassette-bg.png" alt="cassette">
    <div class="track-list" id="trackList"></div>
  </div>

  <div class="player-controls">
    <button class="ctrl-btn" id="prevBtn" title="戻る">⏮️</button>
    <button class="ctrl-btn" id="rewindBtn" title="巻き戻し">⏪</button>
    <button class="ctrl-btn" id="pauseBtn" title="一時停止">⏸️</button>
    <button class="ctrl-btn" id="playBtn" title="再生">▶️</button>
    <button class="ctrl-btn" id="ffBtn" title="早送り">⏩</button>
    <button class="ctrl-btn" id="nextBtn" title="進む">⏭️</button>
  </div>

  <div class="player-controls touch">
    <button class="ctrl-btn tiny" id="playA">A面</button>
    <button class="ctrl-btn tiny" id="playB">B面</button>
    <button class="ctrl-btn tiny" id="playAll">両面</button>
    <button class="ctrl-btn tiny" id="loopBtn">ループ</button>
  </div>

  <div id="playerDiv" style="display:none;"></div>

  <script>
    let tracksA = [];
    let tracksB = [];
    let currentSide = "A";
    let currentIdx = 0;
    let isLoop = false;
    let playingAll = false;
    let player;
    let YTReady = false;

    function loadFromURL() {
      const params = new URLSearchParams(location.search);
      const data = params.get("data");
      if (data) {
        try {
          const obj = JSON.parse(decodeURIComponent(data));
          if (Array.isArray(obj.tracksA)) tracksA = obj.tracksA;
          if (Array.isArray(obj.tracksB)) tracksB = obj.tracksB;
        } catch {}
      }
    }
    loadFromURL();

    const tabA = document.getElementById("tabA");
    const tabB = document.getElementById("tabB");
    const trackTitle = document.getElementById("trackTitle");
    const trackUrl = document.getElementById("trackUrl");
    const addBtn = document.getElementById("addBtn");
    const trackList = document.getElementById("trackList");
    const shareBtn = document.getElementById("shareBtn");
    const shareMsg = document.getElementById("shareMsg");

    const prevBtn = document.getElementById("prevBtn");
    const rewindBtn = document.getElementById("rewindBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const playBtn = document.getElementById("playBtn");
    const ffBtn = document.getElementById("ffBtn");
    const nextBtn = document.getElementById("nextBtn");

    const playA = document.getElementById("playA");
    const playB = document.getElementById("playB");
    const playAll = document.getElementById("playAll");
    const loopBtn = document.getElementById("loopBtn");

    tabA.onclick = () => {
      currentSide = "A";
      tabA.classList.add("active");
      tabB.classList.remove("active");
      playingAll = false;
      renderList();
    };
    tabB.onclick = () => {
      currentSide = "B";
      tabB.classList.add("active");
      tabA.classList.remove("active");
      playingAll = false;
      renderList();
    };

    addBtn.onclick = () => {
      const title = trackTitle.value.trim();
      const url = trackUrl.value.trim();
      if (!title || !url) return;
      const list = currentSide === "A" ? tracksA : tracksB;
      list.push({title, url});
      trackTitle.value = "";
      trackUrl.value = "";
      renderList();
    };

    function delTrack(idx) {
      if (playingAll) {
        let list = [...tracksA, ...tracksB];
        if (idx < tracksA.length) tracksA.splice(idx,1);
        else tracksB.splice(idx-tracksA.length,1);
      } else {
        const list = currentSide === "A" ? tracksA : tracksB;
        list.splice(idx,1);
      }
      currentIdx = Math.max(0, Math.min(currentIdx, (currentSide==="A"?tracksA:tracksB).length-1));
      renderList();
    }

    function renderList() {
      let list = [];
      let highlight = -1;
      if (playingAll) {
        list = [...tracksA, ...tracksB];
        if (currentSide === "B") highlight = currentIdx + tracksA.length;
        else highlight = currentIdx;
      } else {
        list = (currentSide === "A" ? tracksA : tracksB);
        highlight = currentIdx;
      }
      let html = "";
      list.forEach((t,i) => {
        html += `<span class="${i === highlight ? "playing" : ""}">
          ${i+1}. ${t.title}
          <button class="del-btn" onclick="delTrack(${i});event.stopPropagation();">×</button>
        </span>`;
      });
      trackList.innerHTML = html || '<span style="opacity:.6;">（曲を追加してください）</span>';
    }

    shareBtn.onclick = () => {
      const params = encodeURIComponent(JSON.stringify({ tracksA, tracksB }));
      const url = `${location.origin}${location.pathname}?data=${params}`;
      navigator.clipboard.writeText(url);
      shareMsg.style.display = "inline";
      setTimeout(() => shareMsg.style.display = "none", 1200);
    };

    window.delTrack = delTrack;

    function loadPlayer(url, seek=0, autoplay=1) {
      let vid = extractVideoId(url);
      if (!vid) return;
      if (player) player.destroy();
      player = new YT.Player('playerDiv', {
        height: '0', width: '0',
        videoId: vid,
        playerVars: { autoplay, start: seek, controls: 0 },
        events: {
          'onReady': () => { if (autoplay) player.playVideo(); },
          'onStateChange': onYTState,
        }
      });
    }
    function extractVideoId(url) {
      const match = url.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
      return match ? match[1] : null;
    }
    function onYTState(e) {
      // 曲終了時
      if (e.data === YT.PlayerState.ENDED) {
        if (playingAll) {
          let totalList = [...tracksA, ...tracksB];
          let idx = (currentSide === "B" ? currentIdx + tracksA.length : currentIdx);
          if (idx < totalList.length - 1) {
            // 次の曲へ
            idx++;
            if (idx < tracksA.length) {
              currentSide = "A";
              currentIdx = idx;
              tabA.classList.add("active"); tabB.classList.remove("active");
            } else {
              currentSide = "B";
              currentIdx = idx - tracksA.length;
              tabA.classList.remove("active"); tabB.classList.add("active");
            }
            playCurrent();
          } else if (isLoop) {
            // 両面ループ時もA面の1曲目から再生
            currentSide = "A";
            currentIdx = 0;
            tabA.classList.add("active"); tabB.classList.remove("active");
            playCurrent();
          }
        } else {
          const list = currentSide === "A" ? tracksA : tracksB;
          if (currentIdx < list.length - 1) {
            currentIdx++;
            playCurrent();
          } else if (isLoop) {
            currentIdx = 0;
            playCurrent();
          }
        }
      }
    }

    function playCurrent() {
      let list = [];
      if (playingAll) {
        list = [...tracksA, ...tracksB];
        let idx = (currentSide === "B" ? currentIdx + tracksA.length : currentIdx);
        if (!list[idx]) return;
        loadPlayer(list[idx].url, 0, 1);
      } else {
        list = (currentSide === "A" ? tracksA : tracksB);
        if (!list[currentIdx]) return;
        loadPlayer(list[currentIdx].url, 0, 1);
      }
      renderList();
    }
    playBtn.onclick = playCurrent;
    pauseBtn.onclick = ()=>{ if (player) player.pauseVideo(); };
    prevBtn.onclick = ()=>{ 
      if (playingAll) {
        let totalList = [...tracksA, ...tracksB];
        let idx = (currentSide === "B" ? currentIdx + tracksA.length : currentIdx);
        if (idx > 0) {
          idx--;
          if (idx < tracksA.length) {
            currentSide = "A";
            currentIdx = idx;
            tabA.classList.add("active"); tabB.classList.remove("active");
          } else {
            currentSide = "B";
            currentIdx = idx - tracksA.length;
            tabA.classList.remove("active"); tabB.classList.add("active");
          }
          playCurrent();
        }
      } else {
        currentIdx=Math.max(0, currentIdx-1); playCurrent();
      }
    };
    nextBtn.onclick = ()=>{ 
      if (playingAll) {
        let totalList = [...tracksA, ...tracksB];
        let idx = (currentSide === "B" ? currentIdx + tracksA.length : currentIdx);
        if (idx < totalList.length-1) {
          idx++;
          if (idx < tracksA.length) {
            currentSide = "A";
            currentIdx = idx;
            tabA.classList.add("active"); tabB.classList.remove("active");
          } else {
            currentSide = "B";
            currentIdx = idx - tracksA.length;
            tabA.classList.remove("active"); tabB.classList.add("active");
          }
          playCurrent();
        }
      } else {
        const list = currentSide === "A" ? tracksA : tracksB;
        if (currentIdx < list.length-1) { currentIdx++; playCurrent(); }
      }
    };
    rewindBtn.onclick = ()=>{ if (player) player.seekTo(Math.max(player.getCurrentTime()-10,0)); };
    ffBtn.onclick = ()=>{ if (player) player.seekTo(player.getCurrentTime()+10); };

    playA.onclick = ()=>{ currentSide="A"; tabA.classList.add("active"); tabB.classList.remove("active"); currentIdx=0; playingAll=false; playCurrent();};
    playB.onclick = ()=>{ currentSide="B"; tabB.classList.add("active"); tabA.classList.remove("active"); currentIdx=0; playingAll=false; playCurrent();};
    playAll.onclick = ()=>{
      playingAll=true;
      currentSide="A";
      tabA.classList.add("active");
      tabB.classList.remove("active");
      currentIdx=0;
      playCurrent();
    };
    loopBtn.onclick = ()=>{
      isLoop = !isLoop;
      loopBtn.classList.toggle("active", isLoop);
    };

    renderList();

    function onYouTubeIframeAPIReady(){ YTReady=true; }
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);
    window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
  </script>
</body>
</html>
