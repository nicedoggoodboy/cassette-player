<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>CassetteTape Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Lucida Console', monospace;
      background: #fff;
      margin: 0;
      padding: 0;
      color: #222;
    }
    h1 {
      text-align: center;
      font-size: 2.7rem;
      letter-spacing: .15em;
      margin-top: 2rem;
    }
    .tab-group {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 1.5rem;
    }
    .tab-btn {
      font-family: 'Lucida Console', monospace;
      padding: 10px 32px;
      border: none;
      border-radius: 12px 12px 0 0;
      background: #eee;
      font-size: 1.1rem;
      cursor: pointer;
      color: #222;
      outline: none;
      transition: background .2s;
    }
    .tab-btn.active {
      background: #222;
      color: #ffe800;
    }
    .input-row {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 1.4rem 0 0.2rem;
    }
    .input-row input {
      font-family: 'Lucida Console', monospace;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #bbb;
      width: 220px;
      font-size: 1.1rem;
      outline: none;
      box-sizing: border-box;
      transition: width .2s;
    }
    .add-btn, .share-btn {
      font-family: 'Lucida Console', monospace;
      padding: 10px 18px;
      border: none;
      background: #222;
      color: #fff;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1rem;
      transition: background .2s;
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
      display: block;
      margin-bottom: 7px;
    }
    .add-btn:hover, .share-btn:hover {
      background: #444;
    }
    .cassette-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 36px 0 20px;
      position: relative;
    }
    .cassette-img {
      width: 600px;
      max-width: 99vw;
      border-radius: 18px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.16);
      position: relative;
      z-index: 0;
      background: #eee;
    }
    .track-list {
      position: absolute;
      top: 8.5%;
      left: 50%;
      transform: translateX(-50%);
      width: 81%;
      color: #fff;
      text-align: center;
      font-weight: bold;
      font-size: 1.19rem;
      text-shadow: 2px 2px 8px #111, 0 1px 0 #222;
      z-index: 2;
      pointer-events: none;
      line-height: 1.6;
      letter-spacing: 1.5px;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .track-list .playing {
      color: #ffe800;
      text-shadow: 2px 2px 8px #444, 0 1px 0 #000;
    }
    .player-controls, .side-controls {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin-top: 18px;
      flex-wrap: wrap;
    }
    .ctrl-btn, .side-btn {
      font-size: 2.3rem;
      background: #f5f5f5;
      border: 2px solid #ddd;
      border-radius: 11px;
      padding: 7px 19px;
      cursor: pointer;
      color: #3890e8;
      margin-bottom: 8px;
      transition: background 0.18s, color 0.18s;
    }
    .ctrl-btn:hover, .ctrl-btn.active,
    .side-btn:hover, .side-btn.active {
      background: #222;
      color: #ffe800;
    }
    .delete-btn {
      font-family: inherit;
      font-size: 1rem;
      color: #fff;
      background: #e54;
      border: none;
      border-radius: 4px;
      padding: 2px 8px;
      margin-left: 10px;
      cursor: pointer;
      vertical-align: middle;
      pointer-events: auto;
    }
    @media (max-width: 730px) {
      h1 { font-size: 1.3rem; }
      .cassette-img { width: 98vw; }
      .track-list { width: 94%; font-size: 1rem;}
      .player-controls, .side-controls { gap: 6px; }
      .ctrl-btn, .side-btn { font-size: 1.3rem; padding: 6px 12px; }
      .input-row {
        flex-direction: column;
        gap: 4px;
        margin: 1.3rem 0 0.4rem;
        width: 96vw;
        max-width: 480px;
        margin-left: auto;
        margin-right: auto;
      }
      .input-row input {
        width: 100%;
        font-size: 1rem;
        margin-bottom: 0px;
      }
      .add-btn, .share-btn {
        width: 100%;
        font-size: 1.1rem;
        margin-bottom: 7px;
        max-width: 100vw;
      }
      .player-controls, .side-controls {
        flex-wrap: wrap;
        justify-content: center;
        width: 98vw;
        margin-left: auto;
        margin-right: auto;
      }
      .ctrl-btn, .side-btn {
        font-size: 1.3rem;
        min-width: 48px;
        padding: 7px 8px;
      }
    }
    @media (max-width: 460px) {
      .track-list { font-size: 0.88rem;}
    }
  </style>
</head>
<body>
  <h1>cassette tape player</h1>

  <div class="tab-group">
    <button class="tab-btn active" id="tabA">A面</button>
    <button class="tab-btn" id="tabB">B面</button>
  </div>

  <div class="input-row" id="inputRow">
    <input type="text" id="trackTitle" placeholder="曲タイトル">
    <input type="text" id="trackUrl" placeholder="YouTubeリンク">
  </div>
  <button class="add-btn" id="addBtn">この面に追加</button>
  <button class="share-btn" id="shareBtn">シェア</button>

  <div class="cassette-container" style="position:relative;">
    <img class="cassette-img" id="cassetteImg" src="cassette-bg.png" alt="cassette">
    <div class="track-list" id="trackList"></div>
  </div>

  <div class="player-controls" id="playerControls">
    <button class="ctrl-btn" id="prevBtn" title="戻る">⏮️</button>
    <button class="ctrl-btn" id="rewindBtn" title="巻き戻し">⏪</button>
    <button class="ctrl-btn" id="pauseBtn" title="一時停止">⏸️</button>
    <button class="ctrl-btn" id="playBtn" title="再生">▶️</button>
    <button class="ctrl-btn" id="ffBtn" title="早送り">⏩</button>
    <button class="ctrl-btn" id="nextBtn" title="進む">⏭️</button>
  </div>
  <div class="side-controls" id="sideControls">
    <button class="side-btn" id="playA">A面</button>
    <button class="side-btn" id="playB">B面</button>
    <button class="side-btn" id="playAll">両面</button>
    <button class="side-btn" id="loopBtn">ループ</button>
  </div>

  <!-- YouTube iframe埋め込み用（非表示） -->
  <div id="playerDiv" style="display:none;"></div>

  <script>
    // 曲データ
    let tracksA = [];
    let tracksB = [];
    let currentSide = "A";
    let currentIdx = 0;
    let isLoop = false;
    let playingAll = false;
    let player;
    let YTReady = false;

    // ページ要素
    const tabA = document.getElementById("tabA");
    const tabB = document.getElementById("tabB");
    const trackTitle = document.getElementById("trackTitle");
    const trackUrl = document.getElementById("trackUrl");
    const addBtn = document.getElementById("addBtn");
    const shareBtn = document.getElementById("shareBtn");
    const trackList = document.getElementById("trackList");

    // コントロールボタン
    const prevBtn = document.getElementById("prevBtn");
    const rewindBtn = document.getElementById("rewindBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const playBtn = document.getElementById("playBtn");
    const ffBtn = document.getElementById("ffBtn");
    const nextBtn = document.getElementById("nextBtn");

    // ワンタッチ再生
    const playA = document.getElementById("playA");
    const playB = document.getElementById("playB");
    const playAll = document.getElementById("playAll");
    const loopBtn = document.getElementById("loopBtn");

    // タブ切り替え
    tabA.onclick = () => {
      currentSide = "A";
      tabA.classList.add("active");
      tabB.classList.remove("active");
      playingAll = false;
      renderList();
    };
    tabB.onclick = () => {
      currentSide = "B";
      tabB.classList.add("active");
      tabA.classList.remove("active");
      playingAll = false;
      renderList();
    };

    addBtn.onclick = () => {
      const title = trackTitle.value.trim();
      const url = trackUrl.value.trim();
      if (!title || !url) return;
      const list = currentSide === "A" ? tracksA : tracksB;
      list.push({title, url});
      trackTitle.value = "";
      trackUrl.value = "";
      renderList();
    };

    // 曲リスト表示（両面はA面→B面全曲を表示）
    function renderList() {
      let list = [];
      let highlight = -1;
      if (playingAll) {
        list = [...tracksA, ...tracksB];
        if (currentSide === "B") highlight = currentIdx + tracksA.length;
        else highlight = currentIdx;
      } else {
        list = (currentSide === "A" ? tracksA : tracksB);
        highlight = currentIdx;
      }
      let html = "";
      list.forEach((t,i) => {
        html += `<span class="${i === highlight ? "playing" : ""}">${i+1}. ${t.title}<button class="delete-btn" onclick="deleteTrack(${i})">×</button></span>`;
      });
      trackList.innerHTML = html || '<span style="opacity:.6;">（曲を追加してください）</span>';
    }

    // 削除機能
    window.deleteTrack = function(i){
      let list = playingAll ? (currentSide === "A" ? tracksA : tracksB) : (currentSide === "A" ? tracksA : tracksB);
      if (playingAll) {
        // 両面の場合はA面/B面の境界で振り分け
        if (i < tracksA.length) { tracksA.splice(i,1); }
        else { tracksB.splice(i-tracksA.length,1); }
      } else {
        list.splice(i,1);
      }
      renderList();
    };

    // YouTube埋め込み
    function loadPlayer(url, seek=0, autoplay=1) {
      let vid = extractVideoId(url);
      if (!vid) return;
      if (player) player.destroy();
      player = new YT.Player('playerDiv', {
        height: '0', width: '0',
        videoId: vid,
        playerVars: { autoplay, start: seek, controls: 0 },
        events: {
          'onReady': () => { if (autoplay) player.playVideo(); },
          'onStateChange': onYTState,
        }
      });
    }
    function extractVideoId(url) {
      const match = url.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
      return match ? match[1] : null;
    }
    function onYTState(e) {
      if (e.data === YT.PlayerState.ENDED) {
        if (playingAll) {
          let totalList = [...tracksA, ...tracksB];
          let idx = (currentSide === "B" ? currentIdx + tracksA.length : currentIdx);
          if (idx < totalList.length-1) {
            idx++;
            if (idx < tracksA.length) {
              currentSide = "A";
              currentIdx = idx;
              tabA.classList.add("active"); tabB.classList.remove("active");
            } else {
              currentSide = "B";
              currentIdx = idx - tracksA.length;
              tabA.classList.remove("active"); tabB.classList.add("active");
            }
            playCurrent();
          } else if (isLoop) {
            currentSide = "A";
            currentIdx = 0;
            tabA.classList.add("active"); tabB.classList.remove("active");
            playCurrent();
          }
        } else {
          const list = currentSide === "A" ? tracksA : tracksB;
          if (currentIdx < list.length-1) {
            currentIdx++;
            playCurrent();
          } else if (isLoop) {
            currentIdx = 0;
            playCurrent();
          }
        }
      }
    }

    // プレイヤー制御
    function playCurrent() {
      let list = [];
      if (playingAll) {
        list = [...tracksA, ...tracksB];
        let idx = (currentSide === "B" ? currentIdx + tracksA.length : currentIdx);
        if (!list[idx]) return;
        loadPlayer(list[idx].url, 0, 1);
      } else {
        list = (currentSide === "A" ? tracksA : tracksB);
        if (!list[currentIdx]) return;
        loadPlayer(list[currentIdx].url, 0, 1);
      }
      renderList();
    }
    playBtn.onclick = playCurrent;
    pauseBtn.onclick = ()=>{ if (player) player.pauseVideo(); };
    prevBtn.onclick = ()=>{ 
      if (playingAll) {
        let totalList = [...tracksA, ...tracksB];
        let idx = (currentSide === "B" ? currentIdx + tracksA.length : currentIdx);
        if (idx > 0) {
          idx--;
          if (idx < tracksA.length) {
            currentSide = "A";
            currentIdx = idx;
            tabA.classList.add("active"); tabB.classList.remove("active");
          } else {
            currentSide = "B";
            currentIdx = idx - tracksA.length;
            tabA.classList.remove("active"); tabB.classList.add("active");
          }
          playCurrent();
        }
      } else {
        currentIdx=Math.max(0, currentIdx-1); playCurrent();
      }
    };
    nextBtn.onclick = ()=>{ 
      if (playingAll) {
        let totalList = [...tracksA, ...tracksB];
        let idx = (currentSide === "B" ? currentIdx + tracksA.length : currentIdx);
        if (idx < totalList.length-1) {
          idx++;
          if (idx < tracksA.length) {
            currentSide = "A";
            currentIdx = idx;
            tabA.classList.add("active"); tabB.classList.remove("active");
          } else {
            currentSide = "B";
            currentIdx = idx - tracksA.length;
            tabA.classList.remove("active"); tabB.classList.add("active");
          }
          playCurrent();
        }
      } else {
        const list = currentSide === "A" ? tracksA : tracksB;
        if (currentIdx < list.length-1) { currentIdx++; playCurrent(); }
      }
    };
    rewindBtn.onclick = ()=>{ if (player) player.seekTo(Math.max(player.getCurrentTime()-10,0)); };
    ffBtn.onclick = ()=>{ if (player) player.seekTo(player.getCurrentTime()+10); };

    // ワンタッチ再生
    playA.onclick = ()=>{ currentSide="A"; tabA.classList.add("active"); tabB.classList.remove("active"); currentIdx=0; playingAll=false; playCurrent();};
    playB.onclick = ()=>{ currentSide="B"; tabB.classList.add("active"); tabA.classList.remove("active"); currentIdx=0; playingAll=false; playCurrent();};
    playAll.onclick = ()=>{
      playingAll=true;
      currentSide="A";
      tabA.classList.add("active");
      tabB.classList.remove("active");
      currentIdx=0;
      playCurrent();
    };
    loopBtn.onclick = ()=>{
      isLoop = !isLoop;
      loopBtn.classList.toggle("active", isLoop);
    };

    // シェア機能
    shareBtn.onclick = () => {
      const state = {
        a: tracksA, b: tracksB
      };
      const base = location.origin + location.pathname;
      const params = new URLSearchParams();
      params.set('a', btoa(unescape(encodeURIComponent(JSON.stringify(tracksA)))));
      params.set('b', btoa(unescape(encodeURIComponent(JSON.stringify(tracksB)))));
      const url = `${base}?${params.toString()}`;
      if (navigator.share) {
        navigator.share({ url }).catch(()=>{ navigator.clipboard.writeText(url); });
      } else {
        navigator.clipboard.writeText(url);
        alert("URLをクリップボードにコピーしました");
      }
    };

    // クエリから復元
    function loadFromQuery(){
      const u = new URL(location.href);
      let qa = u.searchParams.get('a'), qb = u.searchParams.get('b');
      if (qa) tracksA = JSON.parse(decodeURIComponent(escape(atob(qa))));
      if (qb) tracksB = JSON.parse(decodeURIComponent(escape(atob(qb))));
      renderList();
    }
    loadFromQuery();

    // 初期表示
    renderList();

    // YouTube API 読み込み
    function onYouTubeIframeAPIReady(){ YTReady=true; }
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);
    window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
  </script>
</body>
</html>
