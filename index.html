<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>cassette tape player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Lucida Console', monospace;
      background: #fff;
      margin: 0;
      padding: 0;
      color: #222;
    }
    h1 {
      text-align: center;
      font-size: 2.7rem;
      letter-spacing: .15em;
      margin-top: 2rem;
    }
    .tab-group {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 1.5rem;
    }
    .tab-btn {
      font-family: 'Lucida Console', monospace;
      padding: 10px 32px;
      border: none;
      border-radius: 12px 12px 0 0;
      background: #eee;
      font-size: 1.1rem;
      cursor: pointer;
      color: #222;
      outline: none;
      transition: background .2s;
    }
    .tab-btn.active {
      background: #222;
      color: #ffe800;
    }
    .input-row {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 1.4rem 0 0.2rem;
    }
    .input-row input {
      font-family: 'Lucida Console', monospace;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #bbb;
      width: 220px;
      font-size: 1.1rem;
      outline: none;
    }
    .add-btn, .share-btn {
      font-family: 'Lucida Console', monospace;
      padding: 10px 18px;
      border: none;
      background: #222;
      color: #fff;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1rem;
      transition: background .2s;
      margin-left: 8px;
    }
    .add-btn:hover, .share-btn:hover {
      background: #444;
    }
    .cassette-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 36px 0 20px;
      position: relative;
    }
    .cassette-img {
      width: 600px;
      max-width: 99vw;
      border-radius: 18px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.16);
      position: relative;
      z-index: 0;
      background: #eee;
    }
    .track-list {
      position: absolute;
      top: 8.5%;
      left: 50%;
      transform: translateX(-50%);
      width: 81%;
      color: #fff;
      text-align: center;
      font-weight: bold;
      font-size: 1.19rem;
      text-shadow: 2px 2px 8px #111, 0 1px 0 #222;
      z-index: 2;
      pointer-events: none;
      line-height: 1.6;
      letter-spacing: 1.5px;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .track-item {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      pointer-events: auto;
      position: relative;
    }
    .track-list .playing {
      color: #ffe800;
      text-shadow: 2px 2px 8px #444, 0 1px 0 #000;
    }
    .del-btn {
      margin-left: 6px;
      background: #fff3;
      color: #fff;
      font-size: 1.15rem;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: background .15s, color .15s;
      pointer-events: auto;
      position: relative;
      top: 1px;
    }
    .del-btn:hover {
      background: #ffe800;
      color: #222;
    }
    .player-controls {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin-top: 18px;
      flex-wrap: wrap;
    }
    .ctrl-btn {
      font-size: 2.3rem;
      background: #f5f5f5;
      border: 2px solid #ddd;
      border-radius: 11px;
      padding: 7px 19px;
      cursor: pointer;
      color: #3890e8;
      margin-bottom: 8px;
      transition: background 0.18s, color 0.18s;
    }
    .ctrl-btn:hover, .ctrl-btn.active {
      background: #222;
      color: #ffe800;
    }
    @media (max-width: 730px) {
      .cassette-img {
        width: 98vw;
      }
      .track-list {
        width: 94%;
        font-size: 0.98rem;
      }
      h1 {
        font-size: 1.4rem;
      }
      .player-controls {
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <h1>cassette tape player</h1>

  <div class="tab-group">
    <button class="tab-btn active" id="tabA">AÈù¢</button>
    <button class="tab-btn" id="tabB">BÈù¢</button>
  </div>

  <div class="input-row">
    <input type="text" id="trackTitle" placeholder="Êõ≤„Çø„Ç§„Éà„É´">
    <input type="text" id="trackUrl" placeholder="YouTube„É™„É≥„ÇØ">
    <button class="add-btn" id="addBtn">„Åì„ÅÆÈù¢„Å´ËøΩÂä†</button>
    <button class="share-btn" id="shareBtn">üîó„Ç∑„Çß„Ç¢</button>
  </div>

  <div class="cassette-container" style="position:relative;">
    <img class="cassette-img" id="cassetteImg" src="cassette-bg.png" alt="cassette">
    <div class="track-list" id="trackList"></div>
  </div>

  <div class="player-controls">
    <button class="ctrl-btn" id="prevBtn" title="Êàª„Çã">‚èÆÔ∏è</button>
    <button class="ctrl-btn" id="rewindBtn" title="Â∑ª„ÅçÊàª„Åó">‚è™</button>
    <button class="ctrl-btn" id="pauseBtn" title="‰∏ÄÊôÇÂÅúÊ≠¢">‚è∏Ô∏è</button>
    <button class="ctrl-btn" id="playBtn" title="ÂÜçÁîü">‚ñ∂Ô∏è</button>
    <button class="ctrl-btn" id="ffBtn" title="Êó©ÈÄÅ„Çä">‚è©</button>
    <button class="ctrl-btn" id="nextBtn" title="ÈÄ≤„ÇÄ">‚è≠Ô∏è</button>
  </div>

  <div class="player-controls" style="margin-bottom:2.4rem;">
    <button class="ctrl-btn" id="playA">AÈù¢</button>
    <button class="ctrl-btn" id="playB">BÈù¢</button>
    <button class="ctrl-btn" id="playAll">‰∏°Èù¢</button>
    <button class="ctrl-btn" id="loopBtn">„É´„Éº„Éó</button>
  </div>

  <!-- YouTube iframeÂüã„ÇÅËæº„ÅøÁî®ÔºàÈùûË°®Á§∫Ôºâ -->
  <div id="playerDiv" style="display:none;"></div>

  <script>
    // Êõ≤„Éá„Éº„Çø
    let tracksA = [];
    let tracksB = [];
    let currentSide = "A";
    let currentIdx = 0;
    let isLoop = false;
    let playingAll = false;
    let player;
    let YTReady = false;

    // „Éö„Éº„Ç∏Ë¶ÅÁ¥†
    const tabA = document.getElementById("tabA");
    const tabB = document.getElementById("tabB");
    const trackTitle = document.getElementById("trackTitle");
    const trackUrl = document.getElementById("trackUrl");
    const addBtn = document.getElementById("addBtn");
    const shareBtn = document.getElementById("shareBtn");
    const trackList = document.getElementById("trackList");

    // „Ç≥„É≥„Éà„É≠„Éº„É´„Éú„Çø„É≥
    const prevBtn = document.getElementById("prevBtn");
    const rewindBtn = document.getElementById("rewindBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const playBtn = document.getElementById("playBtn");
    const ffBtn = document.getElementById("ffBtn");
    const nextBtn = document.getElementById("nextBtn");

    // „ÉØ„É≥„Çø„ÉÉ„ÉÅÂÜçÁîü
    const playA = document.getElementById("playA");
    const playB = document.getElementById("playB");
    const playAll = document.getElementById("playAll");
    const loopBtn = document.getElementById("loopBtn");

    // „Ç∑„Çß„Ç¢„Éú„Çø„É≥
    shareBtn.onclick = () => {
      // „Éó„É¨„Ç§„É™„Çπ„Éà‚ÜíURL„Éë„É©„É°„Éº„ÇøÂåñ
      const encode = arr => arr.map(t => encodeURIComponent(t.title) + ',' + encodeURIComponent(t.url)).join('|');
      const param = `?a=${encode(tracksA)}&b=${encode(tracksB)}`;
      const url = location.origin + location.pathname + param;
      navigator.clipboard.writeText(url);
      shareBtn.textContent = "‚úîÔ∏è„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü!";
      setTimeout(() => { shareBtn.textContent = "üîó„Ç∑„Çß„Ç¢"; }, 1500);
    };

    // URL„Åã„Çâ„É™„Çπ„Éà„ÇíÂæ©ÂÖÉ
    function decodeTracks(str) {
      if (!str) return [];
      return str.split('|').map(pair => {
        const [title, url] = pair.split(',');
        return {title: decodeURIComponent(title||""), url: decodeURIComponent(url||"")};
      }).filter(t => t.title && t.url);
    }
    function loadFromURL() {
      const p = new URLSearchParams(location.search);
      tracksA = decodeTracks(p.get('a'));
      tracksB = decodeTracks(p.get('b'));
    }

    // UI„Çø„Éñ
    tabA.onclick = () => {
      currentSide = "A";
      tabA.classList.add("active");
      tabB.classList.remove("active");
      playingAll = false;
      renderList();
    };
    tabB.onclick = () => {
      currentSide = "B";
      tabB.classList.add("active");
      tabA.classList.remove("active");
      playingAll = false;
      renderList();
    };

    addBtn.onclick = () => {
      const title = trackTitle.value.trim();
      const url = trackUrl.value.trim();
      if (!title || !url) return;
      const list = currentSide === "A" ? tracksA : tracksB;
      list.push({title, url});
      trackTitle.value = "";
      trackUrl.value = "";
      renderList();
    };

    // Êõ≤ÂâäÈô§
    function removeTrack(idx) {
      if (playingAll) {
        const totalLen = tracksA.length + tracksB.length;
        if (idx < tracksA.length) {
          tracksA.splice(idx,1);
        } else {
          tracksB.splice(idx-tracksA.length,1);
        }
      } else {
        if (currentSide === "A") tracksA.splice(idx,1);
        else tracksB.splice(idx,1);
      }
      // „Ç´„É¨„É≥„ÉàÂÜçÁîü‰ΩçÁΩÆË™øÊï¥
      if (currentIdx >= ((currentSide==="A"?tracksA:tracksB).length)) currentIdx = 0;
      renderList();
    }

    // Êõ≤„É™„Çπ„ÉàË°®Á§∫Ôºà‰∏°Èù¢„ÅØAÈù¢‚ÜíBÈù¢ÂÖ®Êõ≤„ÇíË°®Á§∫Ôºâ
    function renderList() {
      let list = [];
      let highlight = -1;
      if (playingAll) {
        list = [...tracksA, ...tracksB];
        if (currentSide === "B") highlight = currentIdx + tracksA.length;
        else highlight = currentIdx;
      } else {
        list = (currentSide === "A" ? tracksA : tracksB);
        highlight = currentIdx;
      }
      let html = "";
      list.forEach((t,i) => {
        html += `<span class="track-item${i === highlight ? " playing" : ""}">
                  ${i+1}. ${t.title}
                  <button class="del-btn" title="ÂâäÈô§" onclick="removeTrackBtn(${i})">&times;</button>
                </span>`;
      });
      trackList.innerHTML = html || '<span style="opacity:.6;">ÔºàÊõ≤„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ</span>';
      // ÂÜçÁîü‰∏≠„ÅÆÊõ≤Áï™Âè∑‰øÆÊ≠£
      if (highlight >= list.length) currentIdx = 0;
    }

    // ÂâäÈô§„Éú„Çø„É≥Áî®„Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞
    window.removeTrackBtn = function(i) {
      removeTrack(i);
    };

    // YouTubeÂüã„ÇÅËæº„Åø
    function loadPlayer(url, seek=0, autoplay=1) {
      let vid = extractVideoId(url);
      if (!vid) return;
      if (player) player.destroy();
      player = new YT.Player('playerDiv', {
        height: '0', width: '0',
        videoId: vid,
        playerVars: { autoplay, start: seek, controls: 0 },
        events: {
          'onReady': () => { if (autoplay) player.playVideo(); },
          'onStateChange': onYTState,
        }
      });
    }
    function extractVideoId(url) {
      const match = url.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
      return match ? match[1] : null;
    }
    function onYTState(e) {
      // Êõ≤ÁµÇ‰∫ÜÊôÇ
      if (e.data === YT.PlayerState.ENDED) {
        if (playingAll) {
          let totalList = [...tracksA, ...tracksB];
          let idx = (currentSide === "B" ? currentIdx + tracksA.length : currentIdx);
          if (idx < totalList.length-1) {
            idx++;
            if (idx < tracksA.length) {
              currentSide = "A";
              currentIdx = idx;
              tabA.classList.add("active"); tabB.classList.remove("active");
            } else {
              currentSide = "B";
              currentIdx = idx - tracksA.length;
              tabA.classList.remove("active"); tabB.classList.add("active");
            }
            playCurrent();
          } else if (isLoop) {
            currentSide = "A";
            currentIdx = 0;
            tabA.classList.add("active"); tabB.classList.remove("active");
            playCurrent();
          }
        } else {
          const list = currentSide === "A" ? tracksA : tracksB;
          if (currentIdx < list.length-1) {
            currentIdx++;
            playCurrent();
          } else if (isLoop) {
            currentIdx = 0;
            playCurrent();
          }
        }
      }
    }

    // „Éó„É¨„Ç§„É§„ÉºÂà∂Âæ°
    function playCurrent() {
      let list = [];
      if (playingAll) {
        list = [...tracksA, ...tracksB];
        let idx = (currentSide === "B" ? currentIdx + tracksA.length : currentIdx);
        if (!list[idx]) return;
        loadPlayer(list[idx].url, 0, 1);
      } else {
        list = (currentSide === "A" ? tracksA : tracksB);
        if (!list[currentIdx]) return;
        loadPlayer(list[currentIdx].url, 0, 1);
      }
      renderList();
    }
    playBtn.onclick = playCurrent;
    pauseBtn.onclick = ()=>{ if (player) player.pauseVideo(); };
    prevBtn.onclick = ()=>{ 
      if (playingAll) {
        let totalList = [...tracksA, ...tracksB];
        let idx = (currentSide === "B" ? currentIdx + tracksA.length : currentIdx);
        if (idx > 0) {
          idx--;
          if (idx < tracksA.length) {
            currentSide = "A";
            currentIdx = idx;
            tabA.classList.add("active"); tabB.classList.remove("active");
          } else {
            currentSide = "B";
            currentIdx = idx - tracksA.length;
            tabA.classList.remove("active"); tabB.classList.add("active");
          }
          playCurrent();
        }
      } else {
        currentIdx=Math.max(0, currentIdx-1); playCurrent();
      }
    };
    nextBtn.onclick = ()=>{ 
      if (playingAll) {
        let totalList = [...tracksA, ...tracksB];
        let idx = (currentSide === "B" ? currentIdx + tracksA.length : currentIdx);
        if (idx < totalList.length-1) {
          idx++;
          if (idx < tracksA.length) {
            currentSide = "A";
            currentIdx = idx;
            tabA.classList.add("active"); tabB.classList.remove("active");
          } else {
            currentSide = "B";
            currentIdx = idx - tracksA.length;
            tabA.classList.remove("active"); tabB.classList.add("active");
          }
          playCurrent();
        }
      } else {
        const list = currentSide === "A" ? tracksA : tracksB;
        if (currentIdx < list.length-1) { currentIdx++; playCurrent(); }
      }
    };
    rewindBtn.onclick = ()=>{ if (player) player.seekTo(Math.max(player.getCurrentTime()-10,0)); };
    ffBtn.onclick = ()=>{ if (player) player.seekTo(player.getCurrentTime()+10); };

    // „ÉØ„É≥„Çø„ÉÉ„ÉÅÂÜçÁîü
    playA.onclick = ()=>{ currentSide="A"; tabA.classList.add("active"); tabB.classList.remove("active"); currentIdx=0; playingAll=false; playCurrent();};
    playB.onclick = ()=>{ currentSide="B"; tabB.classList.add("active"); tabA.classList.remove("active"); currentIdx=0; playingAll=false; playCurrent();};
    playAll.onclick = ()=>{
      playingAll=true;
      currentSide="A";
      tabA.classList.add("active");
      tabB.classList.remove("active");
      currentIdx=0;
      playCurrent();
    };
    loopBtn.onclick = ()=>{
      isLoop = !isLoop;
      loopBtn.classList.toggle("active", isLoop);
    };

    // ÂàùÊúüË°®Á§∫
    loadFromURL();
    renderList();

    // YouTube API Ë™≠„ÅøËæº„Åø
    function onYouTubeIframeAPIReady(){ YTReady=true; }
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);
    window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
  </script>
</body>
</html>
